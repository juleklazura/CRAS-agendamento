{% extends "base.html" %}

{% block content %}
<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <h1 class="my-4">Editar Agendamento</h1>
    <form method="post">
        {{ form.csrf_token }}
        <div class="mb-3">
            {{ form.nome.label(class="form-label") }}
            {{ form.nome(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.cpf.label(class="form-label") }}
            {{ form.cpf(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.telefone.label(class="form-label") }}
            {{ form.telefone(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.data.label(class="form-label") }}
            {{ form.data(class="form-control", id="data") }}
        </div>
        <div class="mb-3">
            {{ form.horario.label(class="form-label") }}
            <select name="horario" id="horario" class="form-control">
                <option value="" disabled>Selecione um horário</option>
                {% for hora in horarios %}
                    <option value="{{ hora }}" {% if hora == agendamento_horario_str %} selected {% endif %}>{{ hora }}</option>
                {% endfor %}
            </select>
            {% if form.horario.errors %}
            <div class="invalid-feedback">
                {{ form.horario.errors[0] }}
            </div>
            {% endif %}
        </div>
        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
    </form>
</div>
<script>
    document.getElementById('data').addEventListener('change', function() {
        var data = this.value;
        var agendamentoHorario = "{{ agendamento_horario_str }}";
        fetch('/get_horarios_disponiveis?data=' + data)
            .then(response => response.json())
            .then(horarios => {
                var horarioSelect = document.getElementById('horario');
                horarioSelect.innerHTML = ''; // Limpa o dropdown de horários
    
                // Verifica se o dia selecionado é sábado (5) ou domingo (6)
                if (new Date(data).getDay() === 5 || new Date(data).getDay() === 6) {
                    var option = document.createElement('option');
                    option.text = 'Não disponível';
                    option.disabled = true;
                    horarioSelect.appendChild(option);
                } else {
                    // Popula o dropdown com os horários disponíveis para os dias úteis
                    horarios.forEach(function(horario) {
                        var option = document.createElement('option');
                        option.value = horario;
                        option.textContent = horario;
                        horarioSelect.appendChild(option);
                    });
                    // Adiciona o horário atual do agendamento se não estiver nos horários disponíveis
                    if (!horarios.includes(agendamentoHorario)) {
                        var currentOption = document.createElement('option');
                        currentOption.value = agendamentoHorario;
                        currentOption.textContent = agendamentoHorario;
                        currentOption.selected = true;
                        horarioSelect.appendChild(currentOption);
                    }
                }
            });
    });
</script>
{% endblock %}
